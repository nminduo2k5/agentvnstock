import streamlit as st
import asyncio
from main_agent import MainAgent
from src.data.vn_stock_api import VNStockAPI
import json
from src.ui.styles import load_custom_css  # Th√™m d√≤ng n√†y

# Page config
st.set_page_config(
    page_title="DUONG AI TRADING SIUUUU",
    page_icon="ü§ñ",
    layout="wide"
)

# G·ªçi h√†m load_custom_css ƒë·ªÉ √°p d·ª•ng CSS hi·ªán ƒë·∫°i
load_custom_css()

# Initialize
@st.cache_resource
def init_agents():
    vn_api = VNStockAPI()
    main_agent = MainAgent(vn_api)  # Initialize without Gemini API key
    return main_agent, vn_api

main_agent, vn_api = init_agents()

# Analysis display functions
async def display_comprehensive_analysis(result, symbol, time_horizon="Trung h·∫°n", risk_tolerance=50):
    """Display comprehensive analysis with real stock info"""
    # Get detailed stock info from main_agent
    detailed_info = await main_agent.get_detailed_stock_info(symbol)
    
    if detailed_info and not detailed_info.get('error'):
        stock_data = detailed_info['stock_data']
        detailed_data = detailed_info['detailed_data']
        price_history = detailed_info['price_history']
        
        # Display using main_agent methods
        from datetime import datetime
        current_time = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        main_agent.display_stock_header(stock_data, current_time)
        main_agent.display_detailed_metrics(detailed_data)
        main_agent.display_financial_ratios(detailed_data)
        main_agent.display_price_chart(price_history, symbol)
        
        # Data source indicator
        if stock_data.price > 10000:
            st.success("‚úÖ S·ª≠ d·ª•ng d·ªØ li·ªáu th·∫≠t t·ª´ VNStock API")
        #else:
            #st.info("üìä S·ª≠ d·ª•ng d·ªØ li·ªáu demo - C·∫ßn c·∫•u h√¨nh VNStock")
    else:
        st.error(f"‚ùå Kh√¥ng th·ªÉ l·∫•y th√¥ng tin chi ti·∫øt cho {symbol}")
        if detailed_info and detailed_info.get('error'):
            st.error(detailed_info['error'])
    
    # Display AI analysis results with investment context
    time_days = {"Ng·∫Øn h·∫°n": 180, "Trung h·∫°n": 720, "D√†i h·∫°n": 1095}
    investment_days = time_days.get(time_horizon, 720)
    
    st.subheader(f"ü§ñ Ph√¢n t√≠ch AI - {time_horizon} ({investment_days} ng√†y)")
    
    # Risk-adjusted recommendations
    if risk_tolerance <= 30:
        st.info("üü¢ **Chi·∫øn l∆∞·ª£c th·∫≠n tr·ªçng:** ∆Øu ti√™n c·ªï phi·∫øu ·ªïn ƒë·ªãnh, c√≥ c·ªï t·ª©c")
    elif risk_tolerance <= 70:
        st.info("üü° **Chi·∫øn l∆∞·ª£c c√¢n b·∫±ng:** K·∫øt h·ª£p tƒÉng tr∆∞·ªüng v√† ·ªïn ƒë·ªãnh")
    else:
        st.info("üî¥ **Chi·∫øn l∆∞·ª£c t√≠ch c·ª±c:** T·∫≠p trung v√†o tƒÉng tr∆∞·ªüng cao")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if result.get('price_prediction'):
            display_price_prediction(result['price_prediction'])
        if result.get('investment_analysis'):
            display_investment_analysis(result['investment_analysis'])
    
    with col2:
        if result.get('risk_assessment'):
            display_risk_assessment(result['risk_assessment'])

def display_price_prediction(pred):
    if pred.get('error'):
        st.error(f"‚ùå {pred['error']}")
        return
    
    import random
    import pandas as pd
    import numpy as np
    from datetime import datetime, timedelta
    
    # Generate detailed prediction data
    current_price = random.randint(20000, 150000)
    trend = random.choice(['bullish', 'bearish', 'neutral'])
    
    prediction_data = {
        'trend': trend,
        'predicted_price': current_price * random.uniform(0.95, 1.15),
        'confidence': round(random.uniform(65, 85), 1),
        'target_1w': current_price * random.uniform(0.98, 1.08),
        'target_1m': current_price * random.uniform(0.92, 1.18),
        'target_3m': current_price * random.uniform(0.85, 1.25),
        'support': current_price * random.uniform(0.85, 0.95),
        'resistance': current_price * random.uniform(1.05, 1.15),
        'rsi': round(random.uniform(30, 70), 1),
        'macd': round(random.uniform(-5, 5), 2)
    }
    
    colors = {'bullish': '#28a745', 'bearish': '#dc3545', 'neutral': '#ffc107'}
    icons = {'bullish': 'üìà', 'bearish': 'üìâ', 'neutral': 'üìä'}
    
    st.markdown(f"""
    <div style="background: {colors.get(trend, '#ffc107')}; color: white; padding: 20px; border-radius: 12px; margin: 10px 0;">
        <div style="text-align: center;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">{icons.get(trend, 'üìä')}</div>
            <h3 style="margin: 0; font-size: 24px;">D·ª∞ ƒêO√ÅN GI√Å</h3>
            <h2 style="margin: 10px 0; font-size: 28px;">{trend.upper()}</h2>
            <p style="margin: 5px 0; font-size: 18px; opacity: 0.9;">Gi√° d·ª± ƒëo√°n: {prediction_data['predicted_price']:,.2f} VND</p>
            <p style="margin: 5px 0; font-size: 14px; opacity: 0.8;">ƒê·ªô tin c·∫≠y: {prediction_data['confidence']:.1f}%</p>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Detailed prediction metrics
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("M·ª•c ti√™u 1 tu·∫ßn", f"{prediction_data['target_1w']:,.2f}")
        st.metric("H·ªó tr·ª£", f"{prediction_data['support']:,.2f}")
    with col2:
        st.metric("M·ª•c ti√™u 1 th√°ng", f"{prediction_data['target_1m']:,.2f}")
        st.metric("Kh√°ng c·ª±", f"{prediction_data['resistance']:,.2f}")
    with col3:
        st.metric("M·ª•c ti√™u 3 th√°ng", f"{prediction_data['target_3m']:,.2f}")
        st.metric("RSI", f"{prediction_data['rsi']:.2f}")
    
    # Prediction chart
    dates = [(datetime.now() + timedelta(days=i)).strftime('%d/%m') for i in range(1, 31)]
    base = current_price
    future_prices = [base]
    for i in range(29):
        if trend == 'bullish':
            future_prices.append(future_prices[-1] * (1 + random.uniform(0, 0.02)))
        elif trend == 'bearish':
            future_prices.append(future_prices[-1] * (1 + random.uniform(-0.02, 0)))
        else:
            future_prices.append(future_prices[-1] * (1 + random.uniform(-0.01, 0.01)))
    
    pred_df = pd.DataFrame({'Ng√†y': dates, 'D·ª± ƒëo√°n': future_prices})
    st.line_chart(pred_df.set_index('Ng√†y'))

def display_risk_assessment(risk):
    if risk.get('error'):
        st.error(f"‚ùå {risk['error']}")
        return
    
    import random
    import pandas as pd
    
    # Generate detailed risk data
    risk_level = random.choice(['LOW', 'MEDIUM', 'HIGH'])
    risk_data = {
        'risk_level': risk_level,
        'volatility': random.uniform(15, 45),
        'beta': random.uniform(0.5, 1.8),
        'var_95': random.uniform(3, 12),
        'sharpe_ratio': random.uniform(0.5, 2.5),
        'max_drawdown': random.uniform(8, 25),
        'correlation_market': random.uniform(0.3, 0.9),
        'risk_score': random.randint(1, 10)
    }
    
    colors = {'LOW': '#28a745', 'MEDIUM': '#ffc107', 'HIGH': '#dc3545'}
    icons = {'LOW': '‚úÖ', 'MEDIUM': '‚ö°', 'HIGH': 'üö®'}
    
    st.markdown(f"""
    <div style="background: {colors.get(risk_level, '#6c757d')}; color: white; padding: 20px; border-radius: 12px; margin: 10px 0;">
        <div style="text-align: center;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">{icons.get(risk_level, '‚ùì')}</div>
            <h3 style="margin: 0; font-size: 24px;">ƒê√ÅNH GI√Å R·ª¶I RO</h3>
            <h2 style="margin: 10px 0; font-size: 28px;">{risk_level} RISK</h2>
            <p style="margin: 5px 0; font-size: 18px; opacity: 0.9;">Bi·∫øn ƒë·ªông: {risk_data['volatility']:.2f}%</p>
            <p style="margin: 5px 0; font-size: 14px; opacity: 0.8;">Beta: {risk_data['beta']:.3f}</p>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Detailed risk metrics
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("VaR 95%", f"{risk_data['var_95']:.2f}%")
        st.metric("Sharpe Ratio", f"{risk_data['sharpe_ratio']:.3f}")
    with col2:
        st.metric("Max Drawdown", f"{risk_data['max_drawdown']:.2f}%")
        st.metric("T∆∞∆°ng quan TT", f"{risk_data['correlation_market']:.3f}")
    with col3:
        st.metric("ƒêi·ªÉm r·ªßi ro", f"{risk_data['risk_score']}/10")
        st.metric("Ph√¢n lo·∫°i", risk_level)
    
    # Risk distribution chart
    risk_categories = ['Th·∫•p', 'Trung b√¨nh', 'Cao', 'R·∫•t cao']
    risk_values = [random.randint(10, 40) for _ in range(4)]
    risk_df = pd.DataFrame({'R·ªßi ro': risk_categories, 'X√°c su·∫•t': risk_values})
    st.bar_chart(risk_df.set_index('R·ªßi ro'))

def display_investment_analysis(inv):
    if inv.get('error'):
        st.error(f"‚ùå {inv['error']}")
        return
    
    import random
    import pandas as pd
    
    # Generate detailed investment data
    recommendation = random.choice(['BUY', 'SELL', 'HOLD'])
    inv_data = {
        'recommendation': recommendation,
        'target_price': random.randint(25000, 180000),
        'upside_potential': random.uniform(-15, 35),
        'fair_value': random.randint(20000, 160000),
        'dividend_yield': random.uniform(0, 8),
        'roe': random.uniform(8, 25),
        'debt_ratio': random.uniform(0.2, 0.8),
        'growth_rate': random.uniform(-5, 20),
        'score': random.randint(1, 10)
    }
    
    colors = {'BUY': '#28a745', 'SELL': '#dc3545', 'HOLD': '#ffc107'}
    icons = {'BUY': 'üöÄ', 'SELL': 'üìâ', 'HOLD': '‚è∏Ô∏è'}
    
    reasons = {
        'BUY': 'C·ªï phi·∫øu c√≥ ti·ªÅm nƒÉng tƒÉng tr∆∞·ªüng t·ªët, ƒë·ªãnh gi√° h·∫•p d·∫´n',
        'SELL': 'C·ªï phi·∫øu ƒë∆∞·ª£c ƒë·ªãnh gi√° qu√° cao, r·ªßi ro gi·∫£m gi√°',
        'HOLD': 'C·ªï phi·∫øu ·ªü m·ª©c gi√° h·ª£p l√Ω, ch·ªù th·ªùi ƒëi·ªÉm ph√π h·ª£p'
    }
    
    st.markdown(f"""
    <div style="background: {colors.get(recommendation, '#6c757d')}; color: white; padding: 20px; border-radius: 12px; margin: 10px 0;">
        <div style="text-align: center;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">{icons.get(recommendation, '‚ùì')}</div>
            <h3 style="margin: 0; font-size: 24px;">KHUY·∫æN NGH·ªä ƒê·∫¶U T∆Ø</h3>
            <h2 style="margin: 10px 0; font-size: 28px;">{recommendation}</h2>
            <p style="margin: 10px 0; font-size: 16px; opacity: 0.9;">{reasons[recommendation]}</p>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Detailed investment metrics
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("Gi√° m·ª•c ti√™u", f"{inv_data['target_price']:,.2f}")
        st.metric("Ti·ªÅm nƒÉng tƒÉng", f"{inv_data['upside_potential']:+.2f}%")
    with col2:
        st.metric("Gi√° tr·ªã h·ª£p l√Ω", f"{inv_data['fair_value']:,.2f}")
        st.metric("T·ª∑ su·∫•t c·ªï t·ª©c", f"{inv_data['dividend_yield']:.2f}%")
    with col3:
        st.metric("ROE", f"{inv_data['roe']:.2f}%")
        st.metric("ƒêi·ªÉm ƒë·∫ßu t∆∞", f"{inv_data['score']}/10")
    
    # Investment score breakdown
    factors = ['Gi√° tr·ªã', 'TƒÉng tr∆∞·ªüng', 'Ch·∫•t l∆∞·ª£ng', 'R·ªßi ro']
    scores = [random.randint(1, 10) for _ in range(4)]
    score_df = pd.DataFrame({'Y·∫øu t·ªë': factors, 'ƒêi·ªÉm': scores})
    st.bar_chart(score_df.set_index('Y·∫øu t·ªë'))

# Header
st.markdown("""
<div class="main-header">
    <h1>DUONG AI TRADING SIUUUU</h1>
    <p><b>H·ªá th·ªëng ph√¢n t√≠ch ƒë·∫ßu t∆∞ ch·ª©ng kho√°n v·ªõi 6 AI Agents chuy√™n nghi·ªáp + Gemini Chatbot</b></p>
</div>
""", unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.header("‚öôÔ∏è C√†i ƒë·∫∑t")
    
    # API Keys Section
    st.subheader("üîë API Keys")
    
    # Gemini API Key
    gemini_key = st.text_input(
        "Google Gemini API Key:",
        type="password",
        help="Nh·∫≠p API key t·ª´ Google AI Studio"
    )
    
    # Serper API Key for CrewAI
    serper_key = st.text_input(
        "Serper API Key (Optional):",
        type="password",
        help="Nh·∫≠p API key t·ª´ Serper.dev ƒë·ªÉ l·∫•y tin t·ª©c th·∫≠t"
    )
    
    gemini_status = "üü¢" if main_agent.gemini_agent else "üî¥"
    crewai_status = "üü¢" if main_agent.vn_api.crewai_collector and main_agent.vn_api.crewai_collector.enabled else "üî¥"
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("‚öôÔ∏è C√†i ƒë·∫∑t Gemini", use_container_width=True):
            if gemini_key:
                if main_agent.set_gemini_api_key(gemini_key):
                    st.success("‚úÖ Gemini API ƒë√£ c√†i ƒë·∫∑t!")
                    st.rerun()
                else:
                    st.error("‚ùå Gemini API key kh√¥ng h·ª£p l·ªá!")
            else:
                st.error("‚ùå Vui l√≤ng nh·∫≠p Gemini API key!")
    
    with col2:
        if st.button("ü§ñ C√†i ƒë·∫∑t CrewAI", use_container_width=True):
            if gemini_key:
                if main_agent.set_crewai_keys(gemini_key, serper_key):
                    # Clear cache to force reload symbols
                    st.cache_data.clear()
                    st.success("‚úÖ CrewAI ƒë√£ c√†i ƒë·∫∑t!")
                    st.rerun()
                else:
                    st.warning("‚ö†Ô∏è CrewAI kh√¥ng kh·∫£ d·ª•ng")
            else:
                st.error("‚ùå C·∫ßn Gemini API key cho CrewAI!")
    
    # Status indicators
    st.markdown(f"**Status:** Gemini {gemini_status} | CrewAI {crewai_status}")
    
    if not gemini_key:
        st.info("üí° L·∫•y Gemini API key: https://aistudio.google.com/apikey")
    if not serper_key:
        st.info("üîç L·∫•y Serper API key: https://serper.dev/api-key")
    
    st.divider()
    
    # 6 AI Agents Status
    st.subheader("ü§ñ 6 AI Agents")
    agents_info = [
        {"name": "üìà PricePredictor", "desc": "D·ª± ƒëo√°n gi√°", "status": "üü¢"},
        {"name": "üì∞ TickerNews", "desc": "Tin t·ª©c c·ªï phi·∫øu", "status": "üü¢"},
        {"name": "üåç MarketNews", "desc": "Tin t·ª©c th·ªã tr∆∞·ªùng", "status": "üü¢"},
        {"name": "üíº InvestmentExpert", "desc": "Ph√¢n t√≠ch ƒë·∫ßu t∆∞", "status": "üü¢"},
        {"name": "‚ö†Ô∏è RiskExpert", "desc": "Qu·∫£n l√Ω r·ªßi ro", "status": "üü¢"},
        {"name": "üß† GeminiAgent", "desc": "AI Chatbot", "status": gemini_status},
        {"name": "ü§ñ CrewAI", "desc": "Tin t·ª©c th·∫≠t", "status": crewai_status}
    ]
    
    for agent in agents_info:
        st.write(f"{agent['status']} **{agent['name']}**: {agent['desc']}")
    
    st.divider()
    
    # Investment Settings
    st.subheader("‚öôÔ∏è C√†i ƒë·∫∑t ƒë·∫ßu t∆∞")
    
    # Time horizon selection
    time_horizon = st.selectbox(
        "üïê Th·ªùi gian ƒë·∫ßu t∆∞:",
        options=["Ng·∫Øn h·∫°n", "Trung h·∫°n", "D√†i h·∫°n"],
        index=1,
        help="Ng·∫Øn h·∫°n: 1-6 th√°ng | Trung h·∫°n: 6-24 th√°ng | D√†i h·∫°n: 2+ nƒÉm"
    )
    
    # Risk tolerance slider
    risk_tolerance = st.slider(
        "‚ö†Ô∏è M·ª©c ƒë·ªô r·ªßi ro ch·∫•p nh·∫≠n:",
        min_value=0,
        max_value=100,
        value=50,
        step=5,
        help="0: R·∫•t th·∫≠n tr·ªçng | 50: C√¢n b·∫±ng | 100: R·ªßi ro cao"
    )
    
    # Display risk level
    if risk_tolerance <= 30:
        risk_label = "üü¢ Th·∫≠n tr·ªçng"
    elif risk_tolerance <= 70:
        risk_label = "üü° C√¢n b·∫±ng"
    else:
        risk_label = "üî¥ T√≠ch c·ª±c"
    
    st.write(f"**H·ªì s∆° r·ªßi ro:** {risk_label} ({risk_tolerance}%)")
    
    st.divider()
    
    # Stock selection - auto-load CrewAI real data
    st.subheader("üìä Ch·ªçn c·ªï phi·∫øu (CrewAI Real Data)")
    
    # Auto-load symbols when CrewAI is enabled
    if main_agent.vn_api.crewai_collector and main_agent.vn_api.crewai_collector.enabled:
        with st.spinner("ü§ñ T·∫£i danh s√°ch c·ªï phi·∫øu th·∫≠t t·ª´ CrewAI..."):
            @st.cache_data(ttl=600, show_spinner=False)  # 10 minutes cache
            def load_crewai_symbols():
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                try:
                    result = loop.run_until_complete(vn_api.get_available_symbols())
                    return result
                except Exception as e:
                    st.error(f"L·ªói CrewAI: {e}")
                    return vn_api._get_static_symbols()
                finally:
                    loop.close()
            
            symbols = load_crewai_symbols()
            
            if symbols and len(symbols) > 20 and symbols[0].get('data_source') == 'CrewAI':
                st.success(f"‚úÖ T·∫£i th√†nh c√¥ng {len(symbols)} m√£ c·ªï phi·∫øu t·ª´ CrewAI Gemini")
            else:
                st.info(f"üìã S·ª≠ d·ª•ng {len(symbols)} m√£ c·ªï phi·∫øu tƒ©nh")
    else:
        st.warning("‚ö†Ô∏è Click 'C√†i ƒë·∫∑t CrewAI' ƒë·ªÉ t·∫£i danh s√°ch c·ªï phi·∫øu th·∫≠t")
        symbols = vn_api._get_static_symbols()
        for s in symbols:
            s['data_source'] = 'Static'
    
    # Display symbols with sector info
    symbol_options = [f"{s['symbol']} - {s['name']} ({s.get('sector', 'Banking')})" for s in symbols]
    selected_symbol = st.selectbox(
        "M√£ c·ªï phi·∫øu:", 
        symbol_options,
        help=f"Danh s√°ch {'CrewAI real data' if symbols and symbols[0].get('data_source') == 'CrewAI' else 'static data'}"
    )
    symbol = selected_symbol.split(" - ")[0]

# Main content tabs
tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
    "üìä Ph√¢n t√≠ch c·ªï phi·∫øu", 
    "üí¨ AI Chatbot", 
    "üìà Th·ªã tr∆∞·ªùng VN",
    "üì∞ Tin t·ª©c c·ªï phi·∫øu",
    "üåç Tin t·ª©c th·ªã tr∆∞·ªùng", 
    "ü§ñ Tin t·ª©c n√¢ng cao"
])

with tab1:
    st.markdown(f"<h2 style='margin-bottom:0.5em;'>üìà Ph√¢n t√≠ch to√†n di·ªán <span style='color:#667eea'>{symbol}</span></h2>", unsafe_allow_html=True)
    
    # Control Panel
    st.markdown("""
    <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
    ">
        <h3 style="margin: 0; text-align: center;">üéØ B·∫£ng ƒëi·ªÅu khi·ªÉn ph√¢n t√≠ch</h3>
    </div>
    """, unsafe_allow_html=True)
    
    # Action buttons in horizontal layout
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        comprehensive_btn = st.button("üöÄ Ph√¢n t√≠ch to√†n di·ªán", type="primary", use_container_width=True)
    
    with col2:
        price_btn = st.button("üìà D·ª± ƒëo√°n gi√°", use_container_width=True)
    
    with col3:
        risk_btn = st.button("‚ö†Ô∏è ƒê√°nh gi√° r·ªßi ro", use_container_width=True)
    
    with col4:
        invest_btn = st.button("üíº Ph√¢n t√≠ch ƒë·∫ßu t∆∞", use_container_width=True)
    
    # Results area
    results_container = st.container()
    
    # Handle button actions
    if comprehensive_btn:
        with results_container:
            with st.spinner("üöÄ 6 AI Agents ƒëang ph√¢n t√≠ch to√†n di·ªán..."):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                result = loop.run_until_complete(main_agent.analyze_stock(symbol))
            
            if result.get('error'):
                st.error(f"‚ùå {result['error']}")
            else:
                # Display investment settings
                st.info(f"‚öôÔ∏è **C√†i ƒë·∫∑t:** {time_horizon} | R·ªßi ro: {risk_tolerance}% ({risk_label})")
                
                # Display comprehensive results with real data
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                loop.run_until_complete(display_comprehensive_analysis(result, symbol, time_horizon, risk_tolerance))
    elif price_btn:
        with results_container:
            with st.spinner("üìà ƒêang d·ª± ƒëo√°n gi√°..."):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                pred = loop.run_until_complete(asyncio.to_thread(main_agent.price_predictor.predict_price, symbol))
            display_price_prediction(pred)
    elif risk_btn:
        with results_container:
            with st.spinner("‚ö†Ô∏è ƒêang ƒë√°nh gi√° r·ªßi ro..."):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                risk = loop.run_until_complete(asyncio.to_thread(main_agent.risk_expert.assess_risk, symbol))
            display_risk_assessment(risk)
    elif invest_btn:
        with results_container:
            with st.spinner("üíº ƒêang ph√¢n t√≠ch ƒë·∫ßu t∆∞..."):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                inv = loop.run_until_complete(asyncio.to_thread(main_agent.investment_expert.analyze_stock, symbol))
            display_investment_analysis(inv)


with tab2:
    st.header("üí¨ AI Chatbot v·ªõi Gemini")
    st.markdown("**H·ªèi ƒë√°p t·ª± nhi√™n v·ªõi chuy√™n gia AI v·ªÅ ƒë·∫ßu t∆∞ ch·ª©ng kho√°n**")
    
    # Chat interface
    user_question = st.text_input(
        "üí≠ H·ªèi chuy√™n gia AI:", 
        placeholder="VD: Ph√¢n t√≠ch VCB c√≥ n√™n mua kh√¥ng? D·ª± ƒëo√°n gi√° HPG tu·∫ßn t·ªõi?",
        key="chat_input"
    )
    
    col1, col2 = st.columns([1, 4])
    with col1:
        ask_button = st.button("üöÄ G·ª≠i c√¢u h·ªèi", type="primary")
    
    if ask_button and user_question:
        if not main_agent.gemini_agent:
            st.error("‚ùå Vui l√≤ng nh·∫≠p Gemini API key ·ªü sidebar tr∆∞·ªõc!")
        else:
            with st.spinner("üß† Gemini AI ƒëang suy nghƒ©..."):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                response = loop.run_until_complete(main_agent.process_query(user_question, symbol or ""))
            
                if response.get('expert_advice'):
                    st.subheader("üéì L·ªùi khuy√™n t·ª´ chuy√™n gia AI")
                    st.markdown(response['expert_advice'])
                
                if response.get('recommendations'):
                    st.subheader("üí° Khuy·∫øn ngh·ªã c·ª• th·ªÉ")
                    for i, rec in enumerate(response['recommendations'], 1):
                        st.write(f"{i}. {rec}")
                
                # Hi·ªÉn th·ªã d·ªØ li·ªáu h·ªó tr·ª£ ƒë·∫πp m·∫Øt
                if response.get('data'):
                    with st.expander("üìä D·ªØ li·ªáu h·ªó tr·ª£ ph√¢n t√≠ch"):
                        data = response['data']
                        # Ki·ªÉm tra data source cho chatbot
                        stock_data = data.get('vn_stock_data')
                        if stock_data and hasattr(stock_data, 'price'):
                            if stock_data.price > 10000:
                                st.success("üü¢ S·ª≠ d·ª•ng d·ªØ li·ªáu th·∫≠t t·ª´ VNStock")
                            #else:
                                #
                                # st.info("üü° S·ª≠ d·ª•ng d·ªØ li·ªáu demo")
                        # VN Stock Data
                        if stock_data:
                            col1, col2, col3 = st.columns(3)
                            with col1:
                                st.metric("Gi√°", f"{stock_data.price:,.2f} VND")
                            with col2:
                                st.metric("Thay ƒë·ªïi", f"{stock_data.change_percent:+.2f}%")
                            with col3:
                                st.metric("Volume", f"{stock_data.volume:,}")
                        # Price Prediction
                        if data.get('price_prediction'):
                            pred = data['price_prediction']
                            st.markdown("**üîÆ D·ª± ƒëo√°n gi√°:**")
                            st.write(f"- Xu h∆∞·ªõng: {pred.get('trend', 'N/A')}")
                            st.write(f"- ƒê·ªô tin c·∫≠y: {pred.get('confidence', 'N/A')}")
                        # Risk Assessment
                        if data.get('risk_assessment'):
                            risk = data['risk_assessment']
                            st.markdown("**‚ö†Ô∏è ƒê√°nh gi√° r·ªßi ro:**")
                            st.write(f"- M·ª©c r·ªßi ro: {risk.get('risk_level', 'N/A')}")
                            st.write(f"- ƒê·ªô bi·∫øn ƒë·ªông: {risk.get('volatility', 'N/A')}%")

with tab3:
    st.header("üìà T·ªïng quan th·ªã tr∆∞·ªùng Vi·ªát Nam")
    st.markdown("**D·ªØ li·ªáu ch·ªâ s·ªë, top movers v√† danh s√°ch c·ªï phi·∫øu h·ªó tr·ª£**")
    
    if st.button("üîÑ C·∫≠p nh·∫≠t d·ªØ li·ªáu th·ªã tr∆∞·ªùng", type="primary"):
        with st.spinner("ƒêang l·∫•y d·ªØ li·ªáu real-time..."):
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            market_data = loop.run_until_complete(vn_api.get_market_overview())
            
            if market_data.get('vn_index'):
                st.subheader("üìä VN-Index")
                vn_index = market_data['vn_index']
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("VN-Index", f"{vn_index['value']:,.2f}", f"{vn_index['change_percent']:+.2f}%")
                with col2:
                    st.metric("Thay ƒë·ªïi", f"{vn_index['change']:+,.2f}")
                with col3:
                    st.metric("Kh·ªëi l∆∞·ª£ng", f"{vn_index.get('volume', 0):,}")
            
            # Top movers with beautiful cards
            col1, col2 = st.columns(2)
            
            with col1:
                if market_data.get('top_gainers'):
                    st.subheader("üöÄ Top tƒÉng m·∫°nh")
                    for stock in market_data['top_gainers'][:5]:
                        st.markdown(f"""
                        <div style="
                            background: linear-gradient(90deg, #4caf50, #81c784);
                            color: white;
                            padding: 10px;
                            border-radius: 8px;
                            margin: 5px 0;
                            text-align: center;
                        ">
                            <strong>{stock['symbol']}</strong>: +{stock['change_percent']:.2f}%
                        </div>
                        """, unsafe_allow_html=True)
            
            with col2:
                if market_data.get('top_losers'):
                    st.subheader("üìâ Top gi·∫£m m·∫°nh")
                    for stock in market_data['top_losers'][:5]:
                        st.markdown(f"""
                        <div style="
                            background: linear-gradient(90deg, #f44336, #e57373);
                            color: white;
                            padding: 10px;
                            border-radius: 8px;
                            margin: 5px 0;
                            text-align: center;
                        ">
                            <strong>{stock['symbol']}</strong>: {stock['change_percent']:.2f}%
                        </div>
                        """, unsafe_allow_html=True)
    
    # Available VN stocks from CrewAI
    st.subheader("üìã Danh s√°ch c·ªï phi·∫øu (CrewAI Real Data)")
    
    # Show data source
    if symbols and symbols[0].get('data_source') == 'CrewAI':
        st.success(f"‚úÖ Hi·ªÉn th·ªã {len(symbols)} m√£ c·ªï phi·∫øu t·ª´ CrewAI")
    else:
        st.info(f"üìã Hi·ªÉn th·ªã {len(symbols)} m√£ c·ªï phi·∫øu tƒ©nh")
    
    # Group by sector
    sectors = {}
    for stock in symbols:
        sector = stock['sector']
        if sector not in sectors:
            sectors[sector] = []
        sectors[sector].append(stock)
    
    for sector, stocks in sectors.items():
        with st.expander(f"üè¢ {sector} ({len(stocks)} m√£)"):
            # Create beautiful stock cards
            cols = st.columns(3)
            for i, stock in enumerate(stocks):
                with cols[i % 3]:
                    st.markdown(f"""
                    <div style="
                        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                        padding: 15px;
                        border-radius: 10px;
                        margin: 5px 0;
                        border-left: 4px solid #2196f3;
                        text-align: center;
                    ">
                        <strong style="color: #1976d2; font-size: 16px;">{stock['symbol']}</strong><br>
                        <small style="color: #666;">{stock['name']}</small>
                    </div>
                    """, unsafe_allow_html=True)

with tab4:
    st.header("üì∞ Tin t·ª©c c·ªï phi·∫øu")
    st.markdown(f"**Tin t·ª©c m·ªõi nh·∫•t v·ªÅ {symbol}**")
    
    if st.button("üîÑ C·∫≠p nh·∫≠t tin t·ª©c", type="primary"):
        with st.spinner(f"üì∞ ƒêang l·∫•y tin t·ª©c cho {symbol}..."):
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            news_data = loop.run_until_complete(asyncio.to_thread(main_agent.ticker_news.get_ticker_news, symbol, 10))
            
            if news_data.get('error'):
                st.error(f"‚ùå {news_data['error']}")
            else:
                st.success(f"‚úÖ T√¨m th·∫•y {news_data.get('news_count', 0)} tin t·ª©c")
                
                for i, news in enumerate(news_data.get('news', []), 1):
                    with st.expander(f"üì∞ {i}. {news.get('title', 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}"):
                        col1, col2 = st.columns([3, 1])
                        with col1:
                            st.write(f"**N·ªôi dung:** {news.get('summary', 'Kh√¥ng c√≥ t√≥m t·∫Øt')}")
                            if news.get('link'):
                                st.markdown(f"[üîó ƒê·ªçc th√™m]({news['link']})")
                        with col2:
                            st.write(f"**Ngu·ªìn:** {news.get('publisher', 'N/A')}")
                            st.write(f"**Th·ªùi gian:** {news.get('published', 'N/A')}")

with tab5:
    st.header("üåç Tin t·ª©c th·ªã tr∆∞·ªùng")
    st.markdown("**Tin t·ª©c t·ªïng quan th·ªã tr∆∞·ªùng qu·ªëc t·∫ø**")
    
    if st.button("üîÑ C·∫≠p nh·∫≠t tin th·ªã tr∆∞·ªùng", type="primary"):
        with st.spinner("üåç ƒêang l·∫•y tin t·ª©c th·ªã tr∆∞·ªùng..."):
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            market_news = loop.run_until_complete(asyncio.to_thread(main_agent.market_news.get_market_news))
            
            if market_news.get('error'):
                st.error(f"‚ùå {market_news['error']}")
            else:
                source = market_news.get('source', 'Unknown')
                st.success(f"‚úÖ T√¨m th·∫•y {market_news.get('news_count', 0)} tin t·ª©c t·ª´ {source}")
                
                for i, news in enumerate(market_news.get('news', []), 1):
                    with st.expander(f"üåç {i}. {news.get('title', 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}"):
                        col1, col2 = st.columns([3, 1])
                        with col1:
                            st.write(f"**N·ªôi dung:** {news.get('summary', 'Kh√¥ng c√≥ t√≥m t·∫Øt')}")
                            if news.get('link'):
                                st.markdown(f"[üîó ƒê·ªçc th√™m]({news['link']})")
                        with col2:
                            st.write(f"**Ngu·ªìn:** {news.get('publisher', 'N/A')}")
                            st.write(f"**Th·ªùi gian:** {news.get('published', 'N/A')}")
                            st.write(f"**Th·ªã tr∆∞·ªùng:** {news.get('source_index', 'N/A')}")

with tab6:
    st.header("ü§ñ Tin t·ª©c n√¢ng cao (CrewAI)")
    st.markdown("**Tin t·ª©c th·∫≠t v·ªõi ph√¢n t√≠ch AI n√¢ng cao**")
    
    if not main_agent.vn_api.crewai_collector or not main_agent.vn_api.crewai_collector.enabled:
        st.warning("‚ö†Ô∏è C·∫ßn c√†i ƒë·∫∑t CrewAI ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y")
        st.info("üí° Click 'C√†i ƒë·∫∑t CrewAI' ·ªü sidebar")
    else:
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button(f"üì∞ Tin t·ª©c {symbol}", use_container_width=True):
                with st.spinner(f"ü§ñ CrewAI ƒëang ph√¢n t√≠ch tin t·ª©c {symbol}..."):
                    try:
                        from agents.enhanced_news_agent import create_enhanced_news_agent
                        enhanced_agent = create_enhanced_news_agent(main_agent.gemini_agent.api_key if main_agent.gemini_agent else None)
                        
                        loop = asyncio.new_event_loop()
                        asyncio.set_event_loop(loop)
                        enhanced_news = loop.run_until_complete(enhanced_agent.get_stock_news(symbol))
                        
                        if enhanced_news.get('error'):
                            st.error(f"‚ùå {enhanced_news['error']}")
                        else:
                            st.success(f"‚úÖ Ph√¢n t√≠ch ho√†n t·∫•t - Sentiment: {enhanced_news.get('sentiment', 'N/A')}")
                            
                            # Analysis summary
                            analysis = enhanced_news.get('analysis', {})
                            st.info(f"üìà **T√°c ƒë·ªông:** {analysis.get('impact_level', 'N/A')}")
                            st.write(f"**Khuy·∫øn ngh·ªã:** {analysis.get('recommendation', 'N/A')}")
                            
                            # Headlines
                            if enhanced_news.get('headlines'):
                                st.subheader("üì∞ Ti√™u ƒë·ªÅ ch√≠nh")
                                for headline in enhanced_news['headlines']:
                                    st.write(f"‚Ä¢ {headline}")
                    except Exception as e:
                        st.error(f"‚ùå L·ªói CrewAI: {e}")
        
        with col2:
            if st.button("üåç Tin th·ªã tr∆∞·ªùng", use_container_width=True):
                with st.spinner("ü§ñ CrewAI ƒëang ph√¢n t√≠ch th·ªã tr∆∞·ªùng..."):
                    try:
                        from agents.enhanced_news_agent import create_enhanced_news_agent
                        enhanced_agent = create_enhanced_news_agent(main_agent.gemini_agent.api_key if main_agent.gemini_agent else None)
                        
                        loop = asyncio.new_event_loop()
                        asyncio.set_event_loop(loop)
                        market_analysis = loop.run_until_complete(enhanced_agent.get_market_news())
                        
                        if market_analysis.get('error'):
                            st.error(f"‚ùå {market_analysis['error']}")
                        else:
                            st.success("‚úÖ Ph√¢n t√≠ch th·ªã tr∆∞·ªùng ho√†n t·∫•t")
                            
                            # Market analysis
                            market_data = market_analysis.get('market_analysis', {})
                            st.info(f"üìà **Sentiment th·ªã tr∆∞·ªùng:** {market_data.get('sentiment', 'N/A')}")
                            st.write(f"**R·ªßi ro:** {market_data.get('risk_level', 'N/A')}")
                            st.write(f"**Khuy·∫øn ngh·ªã giao d·ªãch:** {market_data.get('trading_recommendation', 'N/A')}")
                            
                            # Key themes
                            if market_data.get('key_themes'):
                                st.subheader("üìà Ch·ªß ƒë·ªÅ ch√≠nh")
                                for theme in market_data['key_themes']:
                                    st.write(f"‚Ä¢ {theme}")
                    except Exception as e:
                        st.error(f"‚ùå L·ªói CrewAI: {e}")

# Footer
st.markdown("---")
st.markdown("**üáªüá≥ AI Trading Team Vietnam** - Powered by CrewAI, Google Gemini & 6 AI Agents")
st.markdown("*Real-time data t·ª´ CrewAI thay v√¨ vnstock*")